<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Sermon Timer</title>

  <!-- ‚úÖ PWA / √çcones -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- ‚úÖ Tema -->
  <meta name="theme-color" content="#F4B400">
  <meta name="background-color" content="#0B0B0B">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0b0b0b;
      --bg2:#111111;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --text:#f8fafc;
      --muted:rgba(248,250,252,.62);
      --border:rgba(255,255,255,.12);

      --primary:#F4B400;
      --primarySoft:rgba(244,180,0,.14);

      --good:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --shadow: 0 14px 36px rgba(0,0,0,.45);
      --shadow2: 0 8px 18px rgba(0,0,0,.35);

      --r:18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 650px at 20% 10%, rgba(244,180,0,0.22), transparent),
        radial-gradient(900px 650px at 90% 20%, rgba(0,0,0,0.75), transparent),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:14px;
    }

    .container{
      width:100%;
      max-width: 680px;
      display:flex;
      flex-direction:column;
      gap:12px;
      margin:0 auto;
    }

    .card{
      background: linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid var(--border);
      border-radius: var(--r);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: relative;
    }

    h1,h2{ margin:0 0 8px 0; letter-spacing:-.02em; }
    h1{ font-size:18px; font-weight:1000; }
    h2{ font-size:16px; font-weight:1000; }

    .muted{ color:var(--muted); font-size:12px; line-height:1.35; }
    label.muted{ display:block; margin: 0 0 6px 2px; }

    .row{ display:flex; gap:10px; }
    .row>*{ flex:1; }

    input{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.35);
      color: var(--text);
      font-size: 14px;
      outline:none;
    }
    input::placeholder{ color: rgba(248,250,252,0.42); }
    input:focus{
      border-color: rgba(244,180,0,0.55);
      box-shadow: 0 0 0 4px rgba(244,180,0,0.12);
    }

    /* ‚úÖ Premium compact buttons */
    .btn{
      width:100%;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color:var(--text);
      padding: 9px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:7px;
      white-space:nowrap;
      transition: transform .06s ease, background .2s ease, border .2s ease;
      user-select:none;
      min-height: 36px;
    }
    .btn:active{ transform: scale(0.985); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    .btn.primary{
      border-color: rgba(244,180,0,0.40);
      background: rgba(244,180,0,0.14);
      color: #ffe07a;
    }
    .btn.good{
      border-color: rgba(34,197,94,.30);
      background: rgba(34,197,94,.12);
      color: #bbf7d0;
    }
    .btn.warn{
      border-color: rgba(245,158,11,.30);
      background: rgba(245,158,11,.12);
      color: #ffd7a3;
    }
    .btn.danger{
      border-color: rgba(239,68,68,.30);
      background: rgba(239,68,68,.12);
      color: #fecaca;
    }
    .btn .ic{ font-size: 13px; opacity: .95; }

    .hidden{ display:none; }

    /* Plan */
    .plan{
      margin-top:10px;
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,0.04);
    }
    .planRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 12px;
      border-top:1px solid rgba(255,255,255,0.08);
    }
    .planRow:first-child{ border-top:none; }
    .planRow b{ font-size: 13px; }
    .planRow span{ font-size: 12px; color: var(--muted); }

    .planRow .left{
      flex: 1;
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .planRow .left input{
      padding: 10px 10px;
      border-radius: 12px;
      font-size: 13px;
      background: rgba(0,0,0,0.28);
    }

    .planRow .mins{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      min-width: 120px;
      gap:10px;
    }
    .planRow .mins input{
      max-width: 78px;
      padding: 8px 8px;
      border-radius: 12px;
      font-size: 13px;
      text-align:center;
    }

    .activeRow{
      background: rgba(244,180,0,0.14);
      border-left: 4px solid rgba(244,180,0,0.88);
    }

    .planStats{
      margin-top:10px;
      text-align:center;
      font-weight:900;
      font-size:12px;
      color: rgba(248,250,252,0.85);
      padding: 9px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
    }

    /* ‚úÖ TopBar grid compact */
    .topBar{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
      align-items:center;
    }

    /* Status */
    .statusLine{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      font-weight:900;
      font-size:13px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(34,197,94,0.18);
      flex: 0 0 auto;
    }

    /* Metrics compact */
    .metrics{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
      margin-top: 10px;
    }
    .metric{
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 8px 10px;
      box-shadow: var(--shadow2);
      min-width: 0;
      text-align:center;
    }
    .metric .label{ font-size:10px; color: var(--muted); font-weight:800; }
    .metric .value{ font-size:15px; font-weight:1000; margin-top:3px; }

    .topicTitle{
      text-align:center;
      font-size: clamp(18px, 5vw, 24px);
      font-weight: 1000;
      margin-top: 14px;
      letter-spacing:-.02em;
      color: #fff;
          padding: 0 12px;
      word-break: break-word;
      overflow-wrap: anywhere;
      max-width: 100%;
}

    .bigTimer{
      text-align:center;
      font-size: clamp(64px, 14vw, 96px);
      font-weight: 1000;
      letter-spacing: -0.05em;
      margin-top: 12px;
      margin-bottom: 6px;
      color: #fff;
      font-variant-numeric: tabular-nums;
      animation: breathe 1.8s ease-in-out infinite;
      user-select:none;
      text-shadow: 0 10px 30px rgba(0,0,0,0.55);
    }

    @keyframes breathe{
      0%   { transform: scale(1); opacity: 1; }
      50%  { transform: scale(1.018); opacity: 0.98; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Progress bar */
    .barOuter{
      height: 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.05);
      overflow:hidden;
      margin: 14px 0 10px 0;
    }
    .barInner{
      height:100%;
      width:0%;
      border-radius:999px;
      background: rgba(244,180,0,0.95);
      transition: width .12s linear;
      position:relative;
      box-shadow: 0 12px 24px rgba(244,180,0,0.18);
    }

    .badge{
      text-align:center;
      font-weight: 950;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      margin-top: 8px;
      font-size:12px;
    }

    .controls{
      display:flex;
      gap:10px;
      margin-top: 12px;
    }

    /* ‚úÖ Bible Mode FULL */
    .bibleMode .metrics,
    .bibleMode #nextHint,
    .bibleMode #planBoxLive,
    .bibleMode .controls,
    .bibleMode .topBar,
    .bibleMode .statusLine,
    .bibleMode .barOuter{
      display:none !important;
    }

    /* ‚úÖ Centraliza e evita ‚Äúestouro‚Äù */
    .bibleMode #liveTitle{ display:none; }

    .bibleMode #currentTopic{
      margin-top: 10vh;
      font-size: clamp(22px, 5vw, 40px);
      line-height: 1.15;
      padding: 0 14px;
      text-align: center;
      word-break: break-word;
      overflow-wrap: anywhere;
      max-width: 100%;
    }

    .bibleMode #timeDisplay{
      margin-top: 14px;
      font-size: clamp(88px, 18vw, 200px);
      line-height: 1;
      padding: 0 10px;
      max-width: 100%;
    }

    /* evita que o card ‚Äúestoure‚Äù */
    .bibleMode.card{
      overflow:hidden;
    }

    /* ‚úÖ Bot√£o sair (pequeno, s√≥ Bible Mode) */
    #exitBibleBtn{
      display:none;
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      padding: 7px 10px;
      min-height: 30px;
      font-size: 11px;
      border-radius: 999px;
      background: rgba(244,180,0,0.14);
      border: 1px solid rgba(244,180,0,0.30);
      color:#ffe07a;
      box-shadow: var(--shadow2);
      width: auto;
    }
    .bibleMode #exitBibleBtn{
      display:flex !important;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
/* Mobile */
    @media (max-width: 520px){
      body{ padding: 10px; }
      .card{ padding: 12px; }
      .bigTimer{ font-size: 78px; }
      .topBar{ grid-template-columns: repeat(2, 1fr); }
    }

    /* Landscape */
    @media (orientation: landscape) and (max-height: 520px){
      .container{ max-width: 980px; }
      .bigTimer{ font-size: 110px; }
      .topicTitle{ font-size: 26px; }
      .topBar{ grid-template-columns: repeat(5, 1fr); }
    }
    @media (orientation: landscape) and (max-height: 520px){
      .bibleMode #timeDisplay{ font-size: 200px; }
      .bibleMode #currentTopic{ margin-top: 6vh; font-size: 40px; }
    }
  
/* ‚úÖ Update Banner */
.updateBanner{
  position: fixed;
  bottom: 14px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 99999;
  display:flex;
  gap:10px;
  align-items:center;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow2);
  font-weight: 900;
  font-size: 12px;
}
.updateBanner button{
  border-radius: 999px;
  padding: 8px 12px;
  border: 1px solid rgba(244,180,0,0.35);
  background: rgba(244,180,0,0.16);
  color:#ffe07a;
  font-weight: 1000;
  cursor:pointer;
}

</style>
</head>

<body>

  <!-- ‚úÖ Update Banner -->
  <div id="updateBanner" class="updateBanner hidden">
    <span>‚ú® Nova vers√£o dispon√≠vel</span>
    <button id="updateBtnBanner">Atualizar</button>
  </div>

<div class="container">

  <!-- SETUP -->
  <div id="setupCard" class="card">
    <h1>‚è±Ô∏è Sermon Timer</h1>
    <p class="muted">Edite nomes e tempos ‚Ä¢ Distribui√ß√£o autom√°tica ou manual ‚Ä¢ Templates.</p>

    <label class="muted">T√≠tulo da Prega√ß√£o</label>
    <input id="sermonTitle" placeholder="Ex: A f√© que vence"/>

    <div class="row" style="margin-top:10px;">
      <div>
        <label class="muted">Tempo total (min)</label>
        <input id="totalMinutes" type="number" min="1" max="180" value="30"/>
      </div>
      <div>
        <label class="muted">Qtd t√≥picos principais</label>
        <input id="mainTopicsCount" type="number" min="1" max="10" value="3"/>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="buildPlanBtn" class="btn good"><span class="ic">üß©</span>Gerar Plano</button>
      <button id="autoDistBtn" class="btn primary" disabled><span class="ic">‚ö°</span>Distribuir Auto</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="fitRemainingBtn" class="btn warn" disabled><span class="ic">üß†</span>Ajustar Resto</button>
    </div>

    <div id="planBox" class="plan hidden"></div>
    <div id="planStats" class="planStats hidden">Usado: 00:00 ‚Ä¢ Total: 00:00 ‚Ä¢ Falta: 00:00</div>

    <div class="row" style="margin-top:12px;">
      <button id="saveTemplateBtn" class="btn warn" disabled><span class="ic">üíæ</span>Salvar</button>
      <button id="loadTemplateBtn" class="btn warn"><span class="ic">üìÇ</span>Carregar</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="startBtn" class="btn primary" disabled><span class="ic">‚ñ∂</span>Iniciar</button>
    </div>
  </div>

  <!-- TIMER -->
  <div id="timerCard" class="card hidden">

    <!-- ‚úÖ Sair do modo B√≠blia -->
    <button id="exitBibleBtn" class="btn"><span class="ic">‚Ü©</span>Sair</button>

    <div class="topBar">
      <button id="bibleModeBtn" class="btn warn"><span class="ic">üìñ</span>B√≠blia</button>
      <button id="fullscreenBtn" class="btn warn"><span class="ic">‚õ∂</span>Tela</button>
      <button id="wakelockBtn" class="btn warn"><span class="ic">‚òÄ</span>Ligada</button>
      <button id="autoAdvanceBtn" class="btn primary"><span class="ic">‚è≠</span>Auto OFF</button>
      <button id="resetBtn" class="btn danger"><span class="ic">‚Ü©</span>Reset</button>
    </div>

    <h2 id="liveTitle">üìå Prega√ß√£o</h2>

    <div class="statusLine">
      <span class="dot" id="statusDot"></span>
      <span id="statusText">Tempo ok</span>
    </div>

    <div class="metrics">
      <div class="metric">
        <div class="label">Total</div>
        <div class="value" id="metricTotal">00:00</div>
      </div>
      <div class="metric">
        <div class="label">Atual</div>
        <div class="value" id="metricCurrentTotal">00:00</div>
      </div>
      <div class="metric">
        <div class="label">Restante</div>
        <div class="value" id="metricTotalRemaining">00:00</div>
      </div>
    </div>

    <div class="topicTitle" id="currentTopic">‚Äî</div>
    <div class="bigTimer" id="timeDisplay">00:00</div>

    <div class="barOuter"><div class="barInner" id="progressBar"></div></div>

    <div class="badge" id="nextHint">Pr√≥ximo: ‚Äî</div>

    <div class="controls">
      <button id="prevBtn" class="btn"><span class="ic">‚¨Ö</span>Voltar</button>
      <button id="pauseBtn" class="btn primary"><span class="ic">‚è∏</span>Pausar</button>
      <button id="nextBtn" class="btn"><span class="ic">‚û°</span>Pr√≥ximo</button>
    </div>

    <div id="planBoxLive" class="plan" style="margin-top:14px;"></div>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);

let plan = [];
let currentIndex = 0;

let running = false;
let startTime = 0;
let elapsedBefore = 0;

let warned30=false, warned10=false, warnedEnd=false, warnedYellow=false, warnedRed=false;

let bibleMode = false;
let autoAdvance = false;
let wakeLock = null;

let rafId = null;
let lastShownSecond = null;

/* ‚úÖ Tap duplo */
let lastTap = 0;

const VIB_30 = [80];
const VIB_10 = [80, 60, 80];
const VIB_END = [260];
const VIB_YELLOW = [120];
const VIB_RED = [120, 80, 120];

function vibrate(pattern){ if(navigator.vibrate) navigator.vibrate(pattern); }

function formatTime(sec){
  sec = Math.max(0, sec);
  const m = Math.floor(sec/60);
  const s = Math.floor(sec%60);
  return String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');
}
function resetWarnings(){
  warned30=warned10=warnedEnd=warnedYellow=warnedRed=false;
}

/* ‚úÖ indicador */
function updatePlanStats(){
  const stats = $("planStats");
  if(plan.length===0){
    stats.classList.add("hidden");
    return;
  }
  stats.classList.remove("hidden");

  const used = plan.reduce((a,t)=>a+t.durationSec,0);
  const total = (parseInt($("totalMinutes").value,10)||0)*60;
  const left = total - used;

  stats.textContent = `Usado: ${formatTime(used)} ‚Ä¢ Total: ${formatTime(total)} ‚Ä¢ Falta: ${formatTime(left)}`;
}

/* ‚úÖ TITULO */
function updateTitleLive(idx, value){ plan[idx].title = value; }
function updateTitleSave(idx, value){
  plan[idx].title = value.trim() || "Sem t√≠tulo";
  renderPlan();
}
window.updateTitleLive = updateTitleLive;
window.updateTitleSave = updateTitleSave;

/* ‚úÖ TEMPO */
function updateMinutesLive(idx, value){
  if(value === ""){
    plan[idx].durationSec = 0;
    updatePlanStats();
    return;
  }
  const minutes = parseInt(value,10);
  if(!isFinite(minutes)) return;
  plan[idx].durationSec = minutes * 60;
  updatePlanStats();
}
function updateMinutesSave(idx, value){
  let minutes = parseInt(value,10);
  if(!minutes || minutes < 1) minutes = 1;
  plan[idx].durationSec = minutes * 60;
  renderPlan();
}
window.updateMinutesLive = updateMinutesLive;
window.updateMinutesSave = updateMinutesSave;

/* =============== Plan =============== */
function buildPlan(){
  const n = parseInt($("mainTopicsCount").value,10);
  if(!n || n<1) return alert("Quantidade de t√≥picos inv√°lida.");

  plan = [{title:"Introdu√ß√£o", durationSec:0}];
  for(let i=1;i<=n;i++) plan.push({title:`T√≥pico ${i}`, durationSec:0});
  plan.push({title:"Conclus√£o", durationSec:0});

  $("planBox").classList.remove("hidden");
  $("autoDistBtn").disabled = false;
  $("fitRemainingBtn").disabled = false;

  autoDistribute();
}

function autoDistribute(){
  const totalMin = parseInt($("totalMinutes").value,10);
  const totalSec = totalMin * 60;
  if(plan.length < 3) return;

  const nMain = plan.length - 2;

  const introSec = Math.round(totalSec * 0.10);
  const conclSec = Math.round(totalSec * 0.15);
  const mainTotal = totalSec - introSec - conclSec;
  const eachMain = Math.floor(mainTotal / nMain);

  plan[0].durationSec = introSec;
  for(let i=1;i<=nMain;i++) plan[i].durationSec = eachMain;
  plan[plan.length-1].durationSec = conclSec;

  const sum = plan.reduce((a,t)=>a+t.durationSec,0);
  const diff = totalSec - sum;
  if(diff !== 0) plan[plan.length-2].durationSec += diff;

  renderPlan();
  $("startBtn").disabled = false;
  $("saveTemplateBtn").disabled = false;
  $("metricTotal").textContent = formatTime(totalSec);
}

function fitRemaining(){
  const totalSec = (parseInt($("totalMinutes").value,10)||0)*60;
  if(totalSec <= 0) return alert("Tempo total inv√°lido.");

  const usedSec = plan.reduce((a,t)=>a+t.durationSec,0);
  let diff = totalSec - usedSec;

  if(diff === 0){
    alert("‚úÖ Os tempos j√° somam o total certinho!");
    return;
  }

  if(diff < 0){
    alert("‚ö†Ô∏è Voc√™ passou do tempo total. Vou ajustar o √∫ltimo t√≥pico para caber.");
    const lastAdjust = plan.length - 2;
    plan[lastAdjust].durationSec = Math.max(60, plan[lastAdjust].durationSec + diff);
    return renderPlan();
  }

  const mainStart = 1;
  const mainEnd = plan.length - 2;
  const count = (mainEnd - mainStart) + 1;
  const addEach = Math.floor(diff / count);

  for(let i=mainStart; i<=mainEnd; i++){ plan[i].durationSec += addEach; }

  const sum2 = plan.reduce((a,t)=>a+t.durationSec,0);
  const diff2 = totalSec - sum2;
  if(diff2 !== 0) plan[mainEnd].durationSec += diff2;

  renderPlan();
}

function renderPlan(updateLive=true){
  const box = $("planBox");
  box.innerHTML = "";

  plan.forEach((t, idx) => {
    const row = document.createElement("div");
    row.className = "planRow";
    row.innerHTML = `
      <div class="left">
        <input value="${t.title.replaceAll('"','&quot;')}"
          oninput="updateTitleLive(${idx}, this.value)"
          onblur="updateTitleSave(${idx}, this.value)" />
        <span>${formatTime(t.durationSec)}</span>
      </div>
      <div class="mins">
        <input type="number" min="1" max="180"
          value="${Math.round(t.durationSec/60)}"
          oninput="updateMinutesLive(${idx}, this.value)"
          onblur="updateMinutesSave(${idx}, this.value)" />
      </div>
    `;
    box.appendChild(row);
  });

  if(updateLive) renderLivePlan();

  const totalSec = (parseInt($("totalMinutes").value,10)||0)*60;
  $("metricTotal").textContent = formatTime(totalSec);

  updatePlanStats();
}

function renderLivePlan(){
  const live = $("planBoxLive");
  live.innerHTML = "";
  plan.forEach((t, idx) => {
    const row = document.createElement("div");
    row.className = "planRow" + (idx === currentIndex ? " activeRow" : "");
    row.innerHTML = `
      <div>
        <b>${t.title}</b><br/>
        <span>${formatTime(t.durationSec)}</span>
      </div>
      <div class="mins">
        <span>${idx === currentIndex ? "‚è±Ô∏è Agora" : ""}</span>
      </div>
    `;
    live.appendChild(row);
  });
}

/* Templates */
const STORAGE_KEY = "sermon_timer_templates_black_mustard_v5";
function getTemplates(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }
  catch(e){ return []; }
}
function saveTemplate(){
  const name = prompt("Nome do template:");
  if(!name) return;

  const templates = getTemplates();
  const data = {
    name,
    sermonTitle: $("sermonTitle").value || "",
    totalMinutes: parseInt($("totalMinutes").value,10),
    mainTopicsCount: parseInt($("mainTopicsCount").value,10),
    plan
  };
  const idx = templates.findIndex(t => t.name.toLowerCase() === name.toLowerCase());
  if(idx>=0) templates[idx]=data; else templates.push(data);

  localStorage.setItem(STORAGE_KEY, JSON.stringify(templates));
  alert("Template salvo!");
}
function loadTemplate(){
  const templates = getTemplates();
  if(templates.length===0) return alert("Nenhum template salvo.");

  const names = templates.map(t => t.name).join("\n‚Ä¢ ");
  const chosen = prompt("Digite o nome:\n\n‚Ä¢ "+names);
  if(!chosen) return;

  const found = templates.find(t => t.name.toLowerCase() === chosen.toLowerCase());
  if(!found) return alert("Template n√£o encontrado.");

  $("sermonTitle").value = found.sermonTitle || "";
  $("totalMinutes").value = found.totalMinutes || 30;
  $("mainTopicsCount").value = found.mainTopicsCount || 3;

  plan = found.plan || [];
  $("planBox").classList.remove("hidden");
  $("autoDistBtn").disabled = plan.length===0;
  $("fitRemainingBtn").disabled = plan.length===0;
  $("startBtn").disabled = plan.length===0;

  renderPlan();
}

/* Setup events */
$("buildPlanBtn").addEventListener("click", buildPlan);
$("autoDistBtn").addEventListener("click", autoDistribute);
$("fitRemainingBtn").addEventListener("click", fitRemaining);
$("saveTemplateBtn").addEventListener("click", saveTemplate);
$("loadTemplateBtn").addEventListener("click", loadTemplate);

$("startBtn").addEventListener("click", () => {
  if(plan.length===0) return alert("Gere o plano primeiro.");
  startPreaching();
});

/* Timer flow */
function showTimer(){
  $("setupCard").classList.add("hidden");
  $("timerCard").classList.remove("hidden");
  $("timerCard").addEventListener("touchend", detectDoubleTap, {passive:true});
  $("timerCard").addEventListener("dblclick", toggleBibleMode);
}

function showSetup(){
  stopLoop();
  releaseWakeLock();
  exitBibleMode();
  $("timerCard").classList.add("hidden");
  $("setupCard").classList.remove("hidden");
  currentIndex=0;
}

function startPreaching(){
  const title = $("sermonTitle").value.trim();
  $("liveTitle").textContent = title ? "üìå "+title : "üìå Prega√ß√£o";

  currentIndex=0;
  showTimer();
  goToTopic(0);
  requestFullscreen();
}

function goToTopic(idx){
  if(idx<0) idx=0;

  if(idx>=plan.length){
    stopLoop();
    $("currentTopic").textContent = "üéâ Finalizado!";
    $("statusText").textContent = "Conclu√≠do";
    $("nextHint").textContent = "Voc√™ terminou todos os blocos.";
    $("timeDisplay").textContent = "00:00";
    vibrate([200,80,200,80,200]);
    renderLivePlan();
    return;
  }

  currentIndex=idx;
  elapsedBefore=0;
  startTime=Date.now();
  running=true;
  lastShownSecond=null;
  resetWarnings();

  $("currentTopic").textContent = plan[currentIndex].title;
  const next = plan[currentIndex+1];
  $("nextHint").textContent = next ? "Pr√≥ximo: "+next.title : "Pr√≥ximo: (fim)";
  $("metricCurrentTotal").textContent = formatTime(plan[currentIndex].durationSec);
  $("timeDisplay").textContent = formatTime(plan[currentIndex].durationSec);

  renderLivePlan();
  startLoop();
}

function startLoop(){
  stopLoop();
  rafId = requestAnimationFrame(loop);
}
function loop(){
  updateUIRealTime();
  rafId = requestAnimationFrame(loop);
}
function stopLoop(){
  if(rafId) cancelAnimationFrame(rafId);
  rafId=null;
}

function totalRemainingSeconds(){
  const current = plan[currentIndex];
  const total = current.durationSec;

  let elapsed = elapsedBefore;
  if(running) elapsed += (Date.now()-startTime)/1000;

  const currentRemaining = Math.max(0, total - elapsed);
  let nextSum=0;
  for(let i=currentIndex+1;i<plan.length;i++) nextSum += plan[i].durationSec;

  return currentRemaining + nextSum;
}

function setStatus(progress){
  const dot = $("statusDot");

  if(progress < 0.70){
    dot.style.background = "var(--good)";
    dot.style.boxShadow = "0 0 0 4px rgba(34,197,94,0.18)";
    $("statusText").textContent = "Tempo ok";
  }else if(progress < 0.90){
    dot.style.background = "var(--warn)";
    dot.style.boxShadow = "0 0 0 4px rgba(245,158,11,0.20)";
    $("statusText").textContent = "Chegando no final";
  }else{
    dot.style.background = "var(--danger)";
    dot.style.boxShadow = "0 0 0 4px rgba(239,68,68,0.20)";
    $("statusText").textContent = "Final do t√≥pico!";
  }
}

/* REAL TIME */
function updateUIRealTime(){
  const current = plan[currentIndex];
  if(!current) return;

  const total = current.durationSec;

  let elapsed = elapsedBefore;
  if(running) elapsed += (Date.now() - startTime)/1000;

  let remaining = total - elapsed;
  if(!isFinite(remaining)) remaining = total;

  const progress = (total > 0) ? (elapsed / total) : 1;

  $("progressBar").style.width = `${Math.min(progress,1)*100}%`;
  $("metricTotalRemaining").textContent = formatTime(totalRemainingSeconds());
  setStatus(progress);

  const tick = Math.max(0, Math.round(remaining));
  if(tick !== lastShownSecond){
    lastShownSecond = tick;
    $("timeDisplay").textContent = formatTime(tick);
  }

  if(progress >= 0.70 && progress < 0.90 && !warnedYellow){ vibrate(VIB_YELLOW); warnedYellow=true; }
  if(progress >= 0.90 && progress < 1.00 && !warnedRed){ vibrate(VIB_RED); warnedRed=true; }
  if(remaining <= 30 && remaining > 10 && !warned30){ vibrate(VIB_30); warned30=true; }
  if(remaining <= 10 && remaining > 0 && !warned10){ vibrate(VIB_10); warned10=true; }
  if(remaining <= 0 && !warnedEnd){
    vibrate(VIB_END); warnedEnd=true;

    if(autoAdvance){ goToTopic(currentIndex+1); }
    else{
      running = false;
      elapsedBefore = total;
      $("pauseBtn").innerHTML = `<span class="ic">‚ñ∂</span>Continuar`;
    }
  }
}

/* Controls */
$("resetBtn").addEventListener("click", showSetup);

$("pauseBtn").addEventListener("click", () => {
  if(running){
    elapsedBefore += (Date.now()-startTime)/1000;
    running=false;
    $("pauseBtn").innerHTML = `<span class="ic">‚ñ∂</span>Continuar`;
    $("statusText").textContent = "Pausado";
  }else{
    startTime = Date.now();
    running=true;
    $("pauseBtn").innerHTML = `<span class="ic">‚è∏</span>Pausar`;
    if(!rafId) startLoop();
  }
});

$("nextBtn").addEventListener("click", () => goToTopic(currentIndex+1));
$("prevBtn").addEventListener("click", () => goToTopic(currentIndex-1));

$("autoAdvanceBtn").addEventListener("click", () => {
  autoAdvance = !autoAdvance;
  $("autoAdvanceBtn").innerHTML = autoAdvance
    ? `<span class="ic">‚è≠</span>Auto ON`
    : `<span class="ic">‚è≠</span>Auto OFF`;
  vibrate([60]);
});

/* Bible mode toggle */
function toggleBibleMode(){ !bibleMode ? enterBibleMode() : exitBibleMode(); }

function detectDoubleTap(e){
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  if(tag === "input" || tag === "button") return;

  const now = Date.now();
  if(now - lastTap < 280){ toggleBibleMode(); }
  lastTap = now;
}

$("bibleModeBtn").addEventListener("click", toggleBibleMode);
$("exitBibleBtn").addEventListener("click", exitBibleMode);

function enterBibleMode(){ bibleMode=true; $("timerCard").classList.add("bibleMode"); vibrate([80]); }
function exitBibleMode(){ bibleMode=false; $("timerCard").classList.remove("bibleMode"); vibrate([50]); }

/* Fullscreen */
async function requestFullscreen(){
  try{
    const el=document.documentElement;
    if(el.requestFullscreen) await el.requestFullscreen();
  }catch(e){}
}
$("fullscreenBtn").addEventListener("click", requestFullscreen);

/* Wake Lock */
async function requestWakeLock(){
  try{
    if(!("wakeLock" in navigator)){
      alert("Wake Lock n√£o suportado.");
      return;
    }
    wakeLock = await navigator.wakeLock.request("screen");
    wakeLock.addEventListener("release", () => {
      wakeLock=null;
      $("wakelockBtn").innerHTML = `<span class="ic">‚òÄ</span>Ligada`;
    });
    $("wakelockBtn").innerHTML = `<span class="ic">‚úÖ</span>Ligada`;
    vibrate([80]);
  }catch(err){
    alert("N√£o foi poss√≠vel ativar. Tente novamente.");
  }
}
async function releaseWakeLock(){
  try{
    if(wakeLock){
      await wakeLock.release();
      wakeLock=null;
      $("wakelockBtn").innerHTML = `<span class="ic">‚òÄ</span>Ligada`;
    }
  }catch(e){}
}
$("wakelockBtn").addEventListener("click", () => wakeLock ? releaseWakeLock() : requestWakeLock());


/* ‚úÖ Detectar atualiza√ß√£o do Service Worker */
let newWorker = null;

function showUpdateBanner(){
  $("updateBanner").classList.remove("hidden");
}

async function forceUpdate(){
  const btn = $("updateBtnBanner");

  btn.textContent = "Atualizando...";
  btn.disabled = true;

  // some o banner imediatamente
  $("updateBanner").classList.add("hidden");

  try{
    const reg = await navigator.serviceWorker.getRegistration();
    if(reg && reg.waiting){
      reg.waiting.postMessage({ action: "skipWaiting" });
    } else if(newWorker){
      newWorker.postMessage({ action: "skipWaiting" });
    }

    // fallback: se o controllerchange n√£o acontecer em 2.5s, recarrega 1 vez
    setTimeout(() => {
      window.location.href = window.location.href.split("?")[0] + "?u=" + Date.now();
    }, 2500);

  } catch(e){
    console.log("Erro update:", e);
    window.location.href = window.location.href.split("?")[0] + "?u=" + Date.now();
  }
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js").then((reg) => {
    reg.addEventListener("updatefound", () => {
      newWorker = reg.installing;
      newWorker.addEventListener("statechange", () => {
        if(newWorker.state === "installed"){
          if(navigator.serviceWorker.controller){
            showUpdateBanner();
          }
        }
      });
    });
  });

  navigator.serviceWorker.addEventListener("controllerchange", () => {
    $("updateBanner").classList.add("hidden");
    window.location.href = window.location.href.split("?")[0] + "?v=" + Date.now();
  });
}

$("updateBtnBanner").addEventListener("click", forceUpdate);

/* Shortcuts */
window.addEventListener("load", () => {
  // ‚úÖ se n√£o tiver worker esperando, n√£o mostra banner
  if("serviceWorker" in navigator){
    navigator.serviceWorker.getRegistration().then((reg) => {
      if(reg && !reg.waiting){
        $("updateBanner").classList.add("hidden");
      }
    });
  }


  const params = new URLSearchParams(window.location.search);
if(params.get("mode") === "bible"){
    enterBibleMode();
    showTimer();
    goToTopic(0);
  }

  if(params.get("start") === "1"){ startPreaching(); }
});
</script>

</body>
</html>
